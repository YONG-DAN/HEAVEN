<?xml version="1.0" encoding="UTF-8"?>
<!-- Sql Mapper -->
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin">

	<!-- 문의 result map -->
	<resultMap type="questionPostVO" id="qPostVO">
		<result column="q_no" property="qNo"/>
		<result column="thread" property="thread"/>
		<result column="q_title" property="qTitle"/>
		<result column="q_contents" property="qContents"/>
		<result column="q_regdate" property="qRegdate"/>
		<result column="q_parent_no" property="qParentNo"/>
		<result column="q_status" property="qStatus"/>
		<collection property="userVO" javaType="userVO" column="q_no"
		select="selectUserByDetail" ></collection>
	</resultMap>
	
	<!-- collection select -->
	<select id="selectUserByDetail" resultType="userVO">
		select u.id, u.password, u.name, u.address, to_char(u.birthday,'yyyy.mm.dd') birthday,
		u.mileage, u.total_use_mileage
		from users u, question q
		where u.id=q.id and q.q_no=#{value}
	</select>
	
	<!-- 전체 문의 목록 출력 -->
	<select id="readAllQuestionList" resultMap="qPostVO">
			select rnum, q.q_no, q.thread, q.q_title, q.q_regdate, q.q_status, q.q_parent_no
			from (select row_number() over(order by thread desc) rnum, q_no, thread, q_title,
			to_char(q_regdate,'yyyy.mm.dd') q_regdate, q_status, q_parent_no, id
			from question order by thread desc) q, users u
			where q.id=u.id and rnum between #{startRowNumber} and  #{endRowNumber}
			order by thread desc
	</select>
	
	<!-- 전체 문의 목록 페이징을 위한 게시글 수 세기 -->
	<select id="getTotalQuestionContentCount" resultType="int">
		select count(*) from question
	</select>
	
	<!-- 문의 상세 보기 -->
	<select id="readQuestionDetail" parameterType="int" resultMap="qPostVO">
		select q_no, thread, q_title, q_contents, to_char(q_regdate,'yyyy.mm.dd') q_regdate, q_parent_no, q_status
		from question where q_no=#{value}
	</select>
	
	<!-- 문의 답변하기 -->
	<insert id="createQuestionAnswer" parameterType="questionPostVO">
	   <selectKey keyProperty="qNo" resultType="int" order="AFTER">
          select question_seq.currval from dual
       </selectKey>
		<!-- insert into question(q_no, thread, q_title, q_contents, q_parent_no, q_status, id)
		values(question_seq.nextval, #{qNo}*100-1, #{qTitle}, #{qContents}, #{qNo},'답변',#{userVO.id}) -->
		insert into question(q_no, thread, q_title, q_contents, q_parent_no, q_status, id)
		values(question_seq.nextval, #{qNo}*100-1, #{qTitle}, #{qContents}, #{qNo},'답변',#{userVO.id})
	</insert>
	
	<!-- 문의 글 상태 업데이트 -->
	<update id="updateQuestionStatus" parameterType="questionPostVO">
		update question set q_status='답변완료' where q_no=#{qNo}
	</update>
	
</mapper>