<?xml version="1.0" encoding="UTF-8"?>
<!-- Sql Mapper -->
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="join">
	<!-- 참여게시판 resultMap -->
	<resultMap type="joinPostVO" id="jpRM">
 		<result column="jp_group_no"  property="joinPostGroupVO.jpGroupNo"/>
 		<result column="jp_progress" property="joinPostStatusVO.jpStuatusNo"/>
 		<association property="userVO" column="id" javaType="userVO" select="selectUser"/>
 	</resultMap>
 	
 	<!-- 회원 resultMap -->
   <resultMap type="userVO" id="userRM">
      <result property="userGroupVO.ugroupNo" column="ugroup_no" />
      <result property="userGroupVO.ugroupName" column="ugroup_name" />
      <result property="userGradeVO.ugradeNo" column="ugrade_no" />
      <result property="userGradeVO.ugradeName" column="ugrade_name" />
   </resultMap>
   
 	<select id="selectUser" resultMap="userRM" resultType="userVO">
		select u.id as id, u.password as password, u.name as name, u.birthday as birthday, u.gender as gender, u.address as address, 
				u.email as email, u.company_no as company, u.mileage as mileage, u.total_use_mileage as total_use_mileage, 
				g.ugroup_no as ugroup_no, g.ugroup_name as ugroup_name, grade.ugrade_no as ugrade_no, grade.ugrade_name as ugrade_name 
 		from users u		
			inner join users_group g on u.ugroup_no=g.ugroup_no
			inner join users_grade grade on u.ugroup_no=grade.ugrade_no 
 		where id=#{id} 			
 	</select>
 	
 	<!-- 신청서 -->
	<insert id="application" parameterType="joinPostVO">
		<selectKey keyProperty="jpNo" resultType="int" order="BEFORE">
 			select join_post_seq.nextval from dual
 		</selectKey>
		insert into join_post(jp_no, jp_title, jp_contents, jp_summary, <if test="jpPlace!=null">jp_place,</if> jp_app_start_date, jp_app_end_date,
		<if test="jpEventStartDate!=null">jp_event_start_date,</if> <if test="jpEventEndDate!=null">jp_event_end_date,</if> jp_imgdirectory, jp_regdate, 
		<if test="goalMileage!=null">jp_goal_mileage,</if> <if test="goalEntry!=null">jp_goal_entry,</if> id, jp_group_no)
		values(#{jpNo}, #{jpTitle}, #{jpContents}, #{jpSummary}, #{jpPlace}, #{jpAppStartDate}, #{jpAppEndDate},
		#{jpEventStartDate}, #{jpEventEndDate}, #{jpImgDirect}, sysdate,
		#{goalMileage}, #{goalEntry}, #{userVO.id}, #{joinPostGroupVO.jpGroupNo})
	</insert>
	
	<!-- 재능기부 게시글 목록 -->	
	<select id="readDonationList" resultType="joinPostListVO" resultMap="jpRM">
		select j.jp_no, j.jp_title, j.jp_contents, j.jp_summary, j.jp_place, 
				to_char(j.jp_app_start_date,'yyyy-mm-dd') as jp_app_start_date, to_char(j.jp_app_end_date, 'yyyy-mm-dd') as jp_app_end_date,
				to_char(j.jp_event_start_date, 'yyyy-mm-dd') as jp_event_start_date, to_char(j.jp_event_end_date, 'yyyy-mm-dd') as jp_event_end_date,
				j.jp_imgdirectory, j.jp_regdate, j.jp_goal_mileage, j.jp_total_mileage,
				j.jp_goal_entry, j.jp_total_entry, j.jp_status, j.id, j.jp_group_no, j.jp_progress 
		from (select 
				row_number() over (order by jp_no desc) as rnum, jp_no, jp_title, jp_contents, jp_summary, jp_place, jp_app_start_date, jp_app_end_date,
				jp_event_start_date, jp_event_end_date, jp_imgdirectory, jp_regdate, jp_goal_mileage, jp_total_mileage,
				jp_goal_entry, jp_total_entry, jp_status, id, jp_group_no, jp_progress 
			from join_post
			where jp_group_no='1' and jp_progress='2' and jp_status='승인'
		)j, join_post jp
		where j.jp_no=jp.jp_no and rnum between #{startRowNumber} and #{endRowNumber}
		order by j.jp_no desc	
	</select>
	
	<!-- 승인된 재능기부 게시물 수 -->
	<select id="readDonationCount" resultType="int" parameterType="pagingBeanFive">
		select count(*)
		from join_post
		where jp_group_no='1' and jp_progress='2' and jp_status='승인' 
	</select>

	<!-- 재능기부 상세 -->
	<select id="readDonationDetail" parameterType="int" resultType="joinPostVO" resultMap="jpRM">
	<!-- 	select jp_no, jp_title, jp_contents, jp_summary, jp_place, to_char(jp_app_start_date,'yyyy-mm-dd') as jp_app_start_date, to_char(jp_app_end_date,'yyyy-mm-dd') as jp_app_end_date,
			to_char(jp_event_start_date,'yyyy-mm-dd') as jp_event_start_date, to_char(jp_event_end_date,'yyyy-mm-dd') as jp_event_end_date, jp_imgdirectory, jp_regdate, jp_goal_mileage, jp_total_mileage,
			jp_goal_entry, jp_total_entry, jp_status, id, jp_group_no, jp_progress
		from join_post
		where jp_no=#{value} -->
	select
		jp.jp_no as jp_no,
		jp.jp_title as jp_title, 
		jp.jp_contents as jp_contents, 
		jp.jp_summary as jp_summary, 
		jp.jp_place as jp_place, 
		to_char(jp.jp_app_start_date,'yyyy-mm-dd') as jp_app_start_date, 
		to_char(jp.jp_app_end_date, 'yyyy-mm-dd') as jp_app_end_date,
		to_char(jp.jp_event_start_date,'yyyy-mm-dd') as jp_event_start_date, 
		to_char(jp.jp_event_end_date, 'yyyy-mm-dd') as jp_event_end_date,
		jp.jp_imgdirectory as jp_imgdirectory, 
		jp.jp_regdate as jp_regdate, 
		jp.jp_goal_mileage as jp_goal_mileage, 
		jp.jp_total_mileage as jp_total_mileage,
		jp.jp_goal_entry as jp_goal_entry, 
		jp.jp_total_entry as jp_total_entry, 
		jp.jp_status as jp_status, 
		jp.jp_progress as jp_progress, 
		u.id as id, 
		u.name as name,
		g.ugroup_no as ugroup_no, 
		g.ugroup_name as ugroup_name,
		grade.ugrade_no as ugrade_no,
		grade.ugrade_name as ugrade_name
	from join_post jp 
		inner join users u on jp.id=u.id
		inner join users_group g on u.ugroup_no=g.ugroup_no
		inner join users_grade grade on u.ugroup_no=grade.ugrade_no
	where jp.jp_no=#{value}
		
	</select>
</mapper>